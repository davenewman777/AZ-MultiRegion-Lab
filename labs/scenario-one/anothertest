// Step 1: Pre-calculate NSG IDs or properties
var nsgIdMapping = [for (nsg, i) in nsgs: {
  subnetName: '<logic to associate subnet with nsg>' // Replace with your logic
  nsgId: nsg.nsgId
}]

// Step 2: Define subnets with associated NSG
resource subnets 'Microsoft.Network/virtualNetworks/subnets@2020-06-01' = [for subnet in subnetSpec: {
  name: subnet.name
  properties: {
    addressPrefix: subnet.addressPrefix
    networkSecurityGroup: {
      id: nsgIdMapping[<index or condition to match subnet with NSG>].nsgId // Replace with your logic to match the subnet with its NSG
    }
  }
}]